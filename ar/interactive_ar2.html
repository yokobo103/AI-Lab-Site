<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Hand Counter (Stable Version)</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
    }
    video {
      display: none;
    }
  </style>
</head>
<body>
  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    /****************************************************
     * 指本数カウント（左右判定つき・高精度）
     ****************************************************/
    function countFingers(landmarks, handedness) {
      let count = 0;

      // 親指用（左右で判定が変わる）
      const thumbTip = landmarks[4];
      const thumbIP  = landmarks[3];

      let thumbExtended = false;

      if (handedness === "Right") {
        // 右手 → 親指は左方向に伸びる（xが小さくなる）
        thumbExtended = thumbTip.x < thumbIP.x;
      } else {
        // 左手 → 親指は右方向に伸びる（xが大きくなる）
        thumbExtended = thumbTip.x > thumbIP.x;
      }

      if (thumbExtended) count++;

      // 他の4本（tip が base より上にあれば伸びている）
      const fingers = [
        { tip: 8, base: 5 },   // 人差し指
        { tip: 12, base: 9 },  // 中指
        { tip: 16, base: 13 }, // 薬指
        { tip: 20, base: 17 }  // 小指
      ];

      for (const f of fingers) {
        const tip  = landmarks[f.tip];
        const base = landmarks[f.base];

        if (tip.y < base.y) count++;
      }

      return count;
    }

    /****************************************************
     * 描画処理
     ****************************************************/
    window.onload = async () => {
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      /****************************************************
       * MediaPipe Hands 初期化
       ****************************************************/
      const hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
      });

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
      });

      hands.onResults(onResults);

      const camera = new Camera(video, {
        onFrame: async () => {
          await hands.send({ image: video });
        },
        width: 640,
        height: 480
      });
      camera.start();

      /****************************************************
       * onResults（両手の指本数を画面に表示）
       ****************************************************/
      function onResults(results) {
        // カメラ映像を左右反転して描画
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);

        const videoW = video.videoWidth;
        const videoH = video.videoHeight;
        const scale = Math.min(canvas.width / videoW, canvas.height / videoH);
        const drawW = videoW * scale;
        const drawH = videoH * scale;
        const offsetX = (canvas.width - drawW) / 2;
        const offsetY = (canvas.height - drawH) / 2;

        ctx.drawImage(video, offsetX, offsetY, drawW, drawH);
        ctx.restore();

        // 両手を処理
        if (results.multiHandLandmarks) {
          for (let i = 0; i < results.multiHandLandmarks.length; i++) {

            const lm = results.multiHandLandmarks[i];
            const handedness = results.multiHandedness[i].label; // "Right" or "Left"

            const fingerCount = countFingers(lm, handedness);

            const hx = lm[5].x * drawW + offsetX;
            const hy = lm[5].y * drawH + offsetY;

            const screenX = canvas.width - hx; // 左右反転
            const screenY = hy;

            // 数字を描画
            ctx.font = "40px sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.95)";
            ctx.strokeStyle = "rgba(0,0,0,0.7)";
            ctx.lineWidth = 5;

            ctx.strokeText(fingerCount, screenX + 20, screenY - 20);
            ctx.fillText(fingerCount, screenX + 20, screenY - 20);

            // 位置マーカー
            ctx.beginPath();
            ctx.arc(screenX, screenY, 8, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(0,255,255,0.8)";
            ctx.fill();
          }
        }
      }
    };
  </script>
</body>
</html>
