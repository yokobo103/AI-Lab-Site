<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Hand Counter (MediaPipe)</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
    }
    video {
      display: none;
    }
  </style>
</head>
<body>
  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    /****************************************************
     * 指本数カウント（MediaPipe版）
     ****************************************************/
    function countFingers(landmarks) {
      const wrist = landmarks[0];
      const palmRef = landmarks[9];

      const palmSize = Math.hypot(
        palmRef.x - wrist.x,
        palmRef.y - wrist.y
      );

      const fingers = [
        { tip: 4, base: 1 },   // 親指
        { tip: 8, base: 5 },   // 人差し指
        { tip: 12, base: 9 },  // 中指
        { tip: 16, base: 13 }, // 薬指
        { tip: 20, base: 17 }  // 小指
      ];

      let count = 0;

      for (const f of fingers) {
        const tip = landmarks[f.tip];
        const base = landmarks[f.base];

        const distTip = Math.hypot(
          tip.x - wrist.x,
          tip.y - wrist.y
        );
        const distBase = Math.hypot(
          base.x - wrist.x,
          base.y - wrist.y
        );

        if (distTip - distBase > palmSize * 0.25) {
          count++;
        }
      }

      if (count === 1) return 0; // ノイズ対策
      return count;
    }

    /****************************************************
     * メイン処理
     ****************************************************/
    window.onload = async () => {
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      /****************************************************
       * MediaPipe Hands 初期化
       ****************************************************/
      const hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
      });

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
      });

      hands.onResults(onResults);

      const camera = new Camera(video, {
        onFrame: async () => {
          await hands.send({ image: video });
        },
        width: 640,
        height: 480
      });
      camera.start();

      /****************************************************
       * 描画（手ごとに数字を表示）
       ****************************************************/
      function onResults(results) {
        // 背景（カメラ映像）を左右反転して描画
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);

        const videoW = video.videoWidth;
        const videoH = video.videoHeight;
        const scale = Math.min(canvas.width / videoW, canvas.height / videoH);
        const drawW = videoW * scale;
        const drawH = videoH * scale;
        const offsetX = (canvas.width - drawW) / 2;
        const offsetY = (canvas.height - drawH) / 2;

        ctx.drawImage(video, offsetX, offsetY, drawW, drawH);
        ctx.restore();

        // 両手処理
        if (results.multiHandLandmarks) {
          for (const lm of results.multiHandLandmarks) {
            const fingerCount = countFingers(lm);

            // 人差し指付け根の座標を使う
            const hx = lm[5].x * drawW + offsetX;
            const hy = lm[5].y * drawH + offsetY;

            // 左右反転後の位置調整
            const screenX = canvas.width - hx;
            const screenY = hy;

            // 指の本数表示
            ctx.font = "40px sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.95)";
            ctx.strokeStyle = "rgba(0,0,0,0.7)";
            ctx.lineWidth = 5;

            ctx.strokeText(fingerCount, screenX + 20, screenY - 20);
            ctx.fillText(fingerCount, screenX + 20, screenY - 20);

            // 目印の点
            ctx.beginPath();
            ctx.arc(screenX, screenY, 8, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(0,255,255,0.8)";
            ctx.fill();
          }
        }
      }
    };
  </script>
</body>
</html>
